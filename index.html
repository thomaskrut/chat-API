<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mess-client</title>
</head>

<body>

    <form>
        <input type="text" id="sender" name="sender" placeholder="Username">
        <br>
        
    
        <textarea name="message" id="message" rows="10" cols="30" placeholder="Message"></textarea>
<br>
        <button onclick="send()">Send</button>
    </form>

    <div id="activeusers"></div>

    <div id="messages"></div>

    <script>

        function send() {
            event.preventDefault()
            const sender = document.getElementById('sender').value
            const message = document.getElementById('message').value
            const receiver = "__everyone__"
            const data = {
                sender,
                receiver,
                message,
            }
            document.getElementById('message').value = ''
            const xhr = new XMLHttpRequest()
            xhr.open('POST', 'https://messserver-thomaskkrut.b4a.run/message')
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.send(JSON.stringify(data))
            initGetMessages(sender)
        }

        function initGetMessages(username) {
            console.log(username)
            setInterval(() => {
                const xhr1 = new XMLHttpRequest()
                xhr1.open('GET', 'https://messserver-thomaskkrut.b4a.run/message/' + "__everyone__")
                xhr1.send()

                const xhr2 = new XMLHttpRequest()
                xhr2.open('GET', 'https://messserver-thomaskkrut.b4a.run/activeusers/' + username)
                xhr2.send()

                xhr2.onload = () => {
                    const activeusers = JSON.parse(xhr2.response)
                    console.log(activeusers)
                    if (activeusers.length > 0) {
                        const activeusersDiv = document.getElementById('activeusers')
                        activeusersDiv.innerHTML = ''
                        activeusers.forEach(activeuser => {
                            const activeuserDiv = document.createElement('div')
                            activeuserDiv.innerHTML = `

                                <p>${activeuser}</p>
                            `
                            activeusersDiv.appendChild(activeuserDiv)
                        })
                    }
                }


                xhr1.onload = () => {
                    const messages = JSON.parse(xhr1.response)
                    console.log(messages)
                    if (messages.length > 0) {
                        const messagesDiv = document.getElementById('messages')
                        messagesDiv.innerHTML = ''
                        messages.forEach(message => {
                            const messageDiv = document.createElement('div')
                            messageDiv.innerHTML = `
                                <h3>${message.sender}</h3>
                                <p>${message.message}</p>
                            `
                            messagesDiv.appendChild(messageDiv)
                        })
                    }
                }
            }, 3000)
        }



    </script>

</body>

</html>